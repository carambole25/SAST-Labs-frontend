<!DOCTYPE html>
    <html lang="fr">
        <head>
        <meta charset="utf-8">
        <title>Projet</title>
        <link rel="stylesheet" href="css/style_game.css">
        </head>
        <body>
            <div id="code_sample"></div>
            <div id="choice"></div>
        </body>
    </html>

<script> // TO FIX c'est vraiment de la merde fait par chatgpt y'a 1000 fois plus simple mais bon pour le mvp ça ira (je dis ça mais dans 2 ans ça aura pas changé) (oui je sais que les commentaires sont publique) (bonjour :D)
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  let url = "http://20.40.47.225:8080/code_sample/"+code;
  fetch(url)
    .then(response => response.text())
    .then(html => {
      const temp = document.createElement("div");
      temp.innerHTML = html;

      const codeContainer = document.getElementById("code_sample");
      const choiceContainer = document.getElementById("choice");

      // Injecter les <pre> dans #code_sample
      temp.querySelectorAll("pre").forEach(pre => codeContainer.appendChild(pre));

      // Injecter les <button> dans #choice
      temp.querySelectorAll("button").forEach(button => choiceContainer.appendChild(button));

      // Transformer les blocs <pre> : ajouter dynamiquement le <code>
      document.querySelectorAll("#code_sample pre").forEach(pre => {
        const header = pre.querySelector("p");
        if (!header) return;

        // Récupère tout le texte brut après le <p>
        const codeLines = Array.from(pre.childNodes)
          .filter(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim())
          .map(n => n.textContent)
          .join("");

        const code = document.createElement("code");
        code.textContent = codeLines;

        // Supprimer tout sauf le header
        pre.innerHTML = '';
        pre.appendChild(header);
        pre.appendChild(code);

        // Style d'affichage
        pre.classList.remove("expanded");
        code.style.display = "none";
        header.classList.add("file-header");

        // Ajoute un toggle
        header.style.cursor = "pointer";
        header.addEventListener("click", () => {
          const expanded = pre.classList.toggle("expanded");
          code.style.display = expanded ? "block" : "none";
        });

        // Highlight.js
        hljs.highlightBlock(code);
      });

      // Extraction optionnelle
      const fichiers = [];
      document.querySelectorAll("#code_sample pre").forEach(pre => {
        const nom = pre.querySelector("p")?.textContent.trim();
        const code = pre.querySelector("code")?.textContent;
        if (nom && code) {
          fichiers.push({ nom, contenu: code });
        }
      });

      console.log(fichiers);
    })
    .catch(error => {
      console.error("Erreur lors du chargement du HTML :", error);
    });
</script>

<script>
  // Donnée à envoyer
  const code_sample = code;

  // Fonction GET avec params dans l'URL
  function sendGetRequest(repId, code_sample) {
    const params = new URLSearchParams({
      repId: repId,
      code_sample: code_sample
    });

    const url = 'http://localhost:8000/submit_response/?' + params.toString();

    fetch(url)
      .then(response => {
        if (!response.ok) throw new Error('Erreur réseau');
        return response.json();
      })
      .then(data => {
        alert(data);
        if (typeof data === "string" && data.includes("Bonne réponse")) {
          window.location.href = "?code="+(parseInt(code) + 1);
        }
      })
      .catch(error => {
        console.error('Erreur:', error);
      });
  }

  // Attendre que les boutons soient dans le DOM (injection async)
  document.addEventListener("DOMContentLoaded", () => {
    const observer = new MutationObserver(() => {
      document.querySelectorAll("#choice button").forEach(button => {
        button.addEventListener("click", () => {
          sendGetRequest(button.id, code_sample);
        });
      });
    });

    observer.observe(document.getElementById("choice"), { childList: true, subtree: true });
  });
</script>


<link rel="stylesheet" href="lib/atom-one-dark.min.js" />
<script src="lib/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
